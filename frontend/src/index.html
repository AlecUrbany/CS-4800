<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SentiSounds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />

    <!-- Added styles from File Two for specific sections -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <style>
      .custom-orange-bg {
        background-color: #d19900;
      }

      .custom-orange-text {
        color: #d19900;
      }

      .custom-purple-bg {
        background-color: #1c0d2c;
      }

      .loader {
        width: 50px;
        aspect-ratio: 1;
        border-radius: 50%;
        border: 8px solid lightblue;
        border-right-color: orange;
        animation: l2 1s infinite linear;
        position: absolute;
        top: 50%;
        left: 50%;
        display: none;
      }

      .like-button {
        font-size: 5em;
      }

      .liked {
        color: red;
      }

      form.flex {
        display: flex;
        align-items: center;
      }

      .genre-card {
        background-color: rgba(209, 153, 0, 0.8);
        padding: 4rem;
        border-radius: 0.5rem;
        margin-left: 2rem;
        margin-right: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .genre-card:hover {
        transform: scale(1.03);
      }

      @media (min-width: 768px) {
        .genre-card {
          margin-left: 18rem;
          margin-right: 18rem;
        }
      }

      .progress-bar {
        width: 300px;
        height: 5px;
        background-color: #ccc;
        cursor: pointer;
      }

      @keyframes l2 {
        to {
          transform: rotate(1turn);
        }
      }

      #exportPlaylistBtn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        padding: 10px 20px;
        background-color: lightgreen;
        color: black;
        border: 2px solid black;
        cursor: pointer;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
      }

      #signUpBtn {
        right: 20px;
        bottom: 20px;
        padding: 10px 20px;
        background-color: lightgreen;
        color: black;
        border: 2px solid black;
        cursor: pointer;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
      }

        /* Styles from File Two */
        body,
        html {
            height: 100%;
            line-height: 1.8;
        }

      .w3-bar .w3-button {
        padding: 16px;
      }

      /* Slideshow container */
      .slideshow-container {
        max-width: 1000px;
        position: relative;
        margin: auto;
      }
    </style>
  </head>

  <body class="custom-purple-bg text-white font-sans">
    <header class="flex justify-between items-center px-4 py-2 w-full pt-6">
      <div class="flex items-center space-x-4">
        <img
          id="spotifyImg"
          src="assets/spotify_icon.png"
          alt="Spotify Logo"
          class="rounded-xl"
          style="width: 50px; height: 50px"
        />
        <div class="flex flex-col">
          <button
            id="connectSpotifyBtn"
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
          >
            Connect to Spotify
          </button>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <img
          src="assets/sentisounds_icon.png"
          alt="SentiSounds Logo"
          class="rounded-full"
          style="width: 100px; height: 100px"
        />
        <div class="flex flex-col">
          <h1 class="text-3xl font-bold">SentiSounds</h1>
          <p class="text-xs">Sounds for the Soul.</p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button id="signUpBtn">Sign-Up</button>
      </div>
    </header>

    <main class="p-4">
      <div>
        <form class="max-w-md mx-auto flex items-center" id="searchForm">
          <select
            id="number-select"
            class="block w-50 p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
          >
            <option value="7">Underground</option>
            <option value="21">Blend</option>
            <option value="30">Popular</option>
          </select>
          <div class="relative ml-4">
            <div
              class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
            >
              <svg
                class="w-5 h-5 text-gray-500 dark:text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21L15 15M17 10c0 3.866-3.134 7-7 7s-7-3.134-7-7 3.134-7 7-7 7 3.134 7 7z"
                ></path>
              </svg>
            </div>
            <input
              type="search"
              id="default-search"
              class="block w-full pl-10 pr-3 py-2 rounded-lg text-sm border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
              placeholder="How are you feeling?"
              required
            />
          </div>
          <button
            type="submit"
            id="searchButton"
            class="ml-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
          >
            Search
          </button>
        </form>
      </div>
      <h2 class="text-4xl font-bold mb-4 text-center pt-6 py-2">Songs</h2>
      <div id="loader" class="loader"></div>
      <div
        id="songsContainer"
        class="grid grid-rows-4 gap-8 mb-8"
        style="position: relative"
      ></div>
    </main>

    <!-- Slideshow container -->
    <!--<div class="slideshow-container">
      <div class="mySlides fade">
        <img src="assets/Listening to music 4.jpg" style="width: 100%" />
      </div>
      <div class="mySlides fade">
        <img src="assets/Kyle-Just-Sentisounds.jpg" style="width: 100%" />
      </div>
      <div class="mySlides fade">
        <img src="assets/Listening to music 4.jpg" style="width: 100%" />
      </div>
    </div>-->
    <button id="exportPlaylistBtn">Export Playlist</button>

    <script>
      const email = localStorage.getItem("email")

      song_id_list = "";
      let songDetailsMap = {};
      let allSongsData = {};

      if (!email){
        document.getElementById("connectSpotifyBtn").hidden = true;
        document.getElementById("spotifyImg").hidden = true;
        document.getElementById("exportPlaylistBtn").hidden = true;
      } else {
        document.getElementById("signUpBtn").hidden = true;

        const formData = new FormData();
        formData.append("email_address", email);
        fetch(`http://172.178.86.238:5000/spotify-check-authentication`, {
          method: "POST",
          body: formData,
        })
        .then((response) => response.json())
                  .then((data) => {
                    if (data.is_authenticated == true) {
                      document.getElementById("exportPlaylistBtn").hidden = false;
                    } else {
                      document.getElementById("exportPlaylistBtn").hidden = true;
                      document.getElementById("connectSpotifyBtn").hidden = false;
                      document.getElementById("spotifyImg").hidden = false;
                    }
                  })
                  .catch((error) => {
                    console.error(`Error checking Spotify auth:`, error);
                  });

      }

      document
        .getElementById("searchForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const enteredPrompt = document.getElementById("default-search").value;
          const loader = document.getElementById("loader");
          const songsContainer = document.getElementById("songsContainer");
          const popularityScore =
            document.getElementById("number-select").value;

          loader.style.display = "block";
          songsContainer.style.display = "none";

          const testURI = "http://172.178.86.238:5000/recommend-songs";

          const params = new URLSearchParams({
            entered_prompt: enteredPrompt,
            email_address: email,
            popularity_score: popularityScore,
          });

          const url = `${testURI}?${params.toString()}`;

          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: "",
          })
            .then((response) => response.json())
            .then((data) => {
              setTimeout(() => {
                if (data.status === "success") {
                  songsContainer.innerHTML = "";
                  data.songs.forEach((song) => {
                    // Store song details in hashmap
                    allSongsData[song.id] = {
                      artistName: song.artists
                        .map((artist) => artist.name)
                        .join(", "),
                      songId: song.id,
                      songName: song.name,
                      previewUrl: song.preview_url,
                      youtubeUrl:
                        song.external_urls.youtube ||
                        "No YouTube URL available",
                    };
                    console.log(songDetailsMap[song.id]);
                    const songElement = document.createElement("div");
                    songElement.classList.add(
                      "genre-card",
                      "custom-orange-bg",
                      "p-4",
                      "rounded"
                    );
                    const albumCoverUrl =
                      song.album.images.length > 0
                        ? song.album.images[0].url
                        : "https://placehold.co/200x200";
                    const artistNames = song.artists
                      .map((artist) => artist.name)
                      .join(", ");

                    let audioControls = "";
                    if (song.preview_url) {
                      audioControls = `
                                    <audio id="audio-${song.id}" src="${song.preview_url}" ontimeupdate="updateProgress(this)" onloadedmetadata="updateProgress(this)"></audio>
                                    <div class="audio-controls">
                                        <button onclick="document.getElementById('audio-${song.id}').play()"><i class="fas fa-play"></i></button>
                                        <button onclick="document.getElementById('audio-${song.id}').pause()"><i class="fas fa-pause"></i></button>
                                        <input type="range" id="progress-${song.id}" value="0" max="100" class="progress-bar" oninput="setAudioPosition(this, 'audio-${song.id}')">
                                        <span id="time-${song.id}">0:00/0:00</span>
                                    </div>
                                `;
                    }

                    let youtubeButtonHTML = "";
                    if (song.external_urls.youtube) {
                      youtubeButtonHTML = `<a href="${song.external_urls.youtube}" target="_blank" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">YouTube</a>`;
                    }

                    songElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        ${youtubeButtonHTML}
                                        <img src="${albumCoverUrl}" alt="${song.name} album cover" class="rounded mb-2" style="width:200px; height:200px;">
                                        <h3 class="text-xl font-bold">${song.name} - ${artistNames}</h3>
                                        ${audioControls}
                                    </div>
                                    <button class="like-button text-black-500 focus:outline-none focus:text-black-700" data-song-id="${song.id}">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>`;
                    songsContainer.appendChild(songElement);
                  });
                  loader.style.display = "none";
                  songsContainer.style.display = "grid";

                  document
                    .querySelectorAll(".like-button")
                    .forEach((button) => {
                      button.addEventListener("click", function () {
                        const songId = this.getAttribute("data-song-id");
                        if (this.classList.contains("liked")) {
                          handleSongInteraction(songId, email, "unlike");
                          this.classList.remove("liked");
                          this.innerHTML = '<i class="fas fa-heart"></i>'; // Change to unfilled heart
                        } else {
                          handleSongInteraction(songId, email, "like");
                          this.classList.add("liked");
                          this.innerHTML = '<i class="fas fa-heart liked"></i>'; // Change to filled heart
                        }
                      });
                    });
                } else {
                  console.error("Failed to get recommended songs:", data.error);
                }
              }, 3000);
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
            });
        });

      function updateProgress(audio) {
        const progressBar = document.getElementById(
          "progress-" + audio.id.split("-")[1]
        );
        const percentage = Math.floor(
          (100 / audio.duration) * audio.currentTime
        );
        progressBar.value = percentage;
        const currentTimeDisplay = formatTime(audio.currentTime);
        const durationDisplay = formatTime(audio.duration);
        const timeLabel = document.getElementById(
          "time-" + audio.id.split("-")[1]
        );
        timeLabel.textContent = `${currentTimeDisplay}/${durationDisplay}`;
      }

      function setAudioPosition(progressBar, audioId) {
        const audio = document.getElementById(audioId);
        const duration = audio.duration;
        audio.currentTime = (progressBar.value / 100) * duration;
      }

      function formatTime(timeInSeconds) {
        const minutes = Math.floor(timeInSeconds / 60);
        const seconds = Math.floor(timeInSeconds % 60);
        return `${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;
      }

      function handleSongInteraction(songId, email, action) {
        if (!email) {
          console.error("User email is required.");
          return; // Stop the function if email is not provided
        }
        const endpoint =
          action === "like" ? "/spotify-like-song" : "/spotify-unlike-song";
        const formData = new FormData();
        formData.append("email_address", email);
        if (action === "like") {
          songDetailsMap[songId] = allSongsData[songId];
        } else if (action === "unlike") {
          delete songDetailsMap[songId];
        }
        console.log(songDetailsMap);
        // song_id_list = song_id_list.concat(songId, " ");
        // console.log(song_id_list);
        fetch(`http://172.178.86.238:5000${endpoint}?song_id=${songId}`, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              console.log(`Song ${action}d successfully.`);
            } else {
              console.error(`Failed to ${action} song:`, data.error);
            }
          })
          .catch((error) => {
            console.error(`Error ${action}ing song:`, error);
          });
      }

      function getSongIdsAsString() {
        // Retrieve all keys (song IDs) from the songDetailsMap
        const allSongIds = Object.keys(songDetailsMap);

        // Join all song IDs into a string separated by spaces
        const songIdsString = allSongIds.join(" ");

        return songIdsString;
      }

      function getURLParameter(name) {
        const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        const results = regex.exec(window.location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      // Extract the 'code' parameter from the URL
      const code = getURLParameter("code");

      // You can now use 'code' variable throughout your script
      console.log("Code extracted from URL:", code);

      if (code.length > 5) {
        document.addEventListener("DOMContentLoaded", async function () {
          const baseURL = "http://172.178.86.238:5000/spotify-authenticate"; // REPLACE IT WITH BASE URL

          // Retrieving data from localStorage
          const email = localStorage.getItem('email');
          const formData = new FormData();
          formData.append("email_address", email);
          formData.append("code", code);

          try {
            const response = await fetch(baseURL, {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (response.ok) {
              alert("Spotify Authentication successful.");
              // window.location.href = "index.html";
            } else {
              alert(data.error);
            }
          } catch (error) {
            console.error("Error during Spotify authentication:", error);
            alert(
              "An error occurred during Spotify Authentication. Please try again."
            );
          }
        });
      }

      document
        .getElementById("connectSpotifyBtn")
        .addEventListener("click", function () {
          fetch("http://172.178.86.238:5000/spotify-auth-link")
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                window.open(data.url, "_blank"); // Opens the Spotify URL in a new tab
              } else {
                console.error("Failed to connect to Spotify:", data.error);
              }
            })
            .catch((error) => {
              console.error("Error fetching the Spotify link:", error);
            });
        });

      document
        .getElementById("signUpBtn")
        .addEventListener("click", function () {
          window.location.href = "signup.html"
        });

      document.addEventListener("DOMContentLoaded", function () {
        const exportButton = document.querySelector("#exportPlaylistBtn");
        exportButton.addEventListener("click", async function () {
          // Example usage:
          const songIdsString = getSongIdsAsString();
          console.log(songIdsString); // Output will be something like "id1 id2 id3"
          const baseURL = "http://172.178.86.238:5000/export-playlist"; // REPLACE IT WITH BASE URL
          const params = new URLSearchParams({
            song_ids: songIdsString,
            playlist_name: "SentiSounds Export",
            playlist_description: "",
          });
          const url = `${baseURL}?${params.toString()}`;
          // Retrieving data from localStorage
          const email = localStorage.getItem('email');

          const formData = new FormData();
          formData.append("email_address", email);

          try {
            const response = await fetch(url, {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (response.ok) {
              alert("Spotify Playlist Export successful.");
              // window.location.href = "index.html";
            } else {
              alert(data.error);
            }
          } catch (error) {
            // console.error('Error during authentication:', error);
            alert("An error occurred during exporting. Please try again.");
          }
        });
      });

      // let slideIndex = 0;
      // showSlides();

      // function showSlides() {
      //   let i;
      //   let slides = document.getElementsByClassName("mySlides");
      //   for (i = 0; i < slides.length; i++) {
      //     slides[i].style.display = "none";
      //   }
      //   slideIndex++;
      //   if (slideIndex > slides.length) {
      //     slideIndex = 1;
      //   }
      //   slides[slideIndex - 1].style.display = "block";
      //   setTimeout(showSlides, 2000); // Change image every 2 seconds
      // }
    </script>
    <!-- <button id="testBtn">Test Auth</button> -->

<!-- Customer Feedback -->
<div class="w3-container" style="padding:128px 16px" id="about">
    <h3 class="w3-center"><b>CUSTOMER FEEDBACK</b></h3>
    <p class="w3-center w3-large">Top reviews from satisfied customers!</p>
    <div class="w3-row-padding w3-center" style="margin-top:64px">
        <div class="w3-quarter">
            <i style="font-size: 48px;"><span class="material-symbols-outlined">
                    favorite
                </span></i>
            <p class="w3-large"><b>Brandon Leho</b></p>
            <p>This website was so cool that I'm worried my girlfriend may leave me for it!</p>
        </div>
        <div class="w3-quarter">
            <i style="font-size: 48px;"><span class="material-symbols-outlined">
                    music_note
                </span></i>
            <p class="w3-large"><b>Juan Salas</b></p>
            <p>My prompt was, "I hate my life", and I was recommended three hours of Nickelback!</p>
        </div>
        <div class="w3-quarter">
            <i style="font-size: 48px;"><span class="material-symbols-outlined">
                    cake
                </span></i>
            <p class="w3-large"><b>Frederick Fazbear</b></p>
            <p>Found great music to get ready for a birthday party!</p>
        </div>
        <div class="w3-quarter">
            <i style="font-size: 48px;"><span class="material-symbols-outlined">
                    humerus
                </span></i>
            <p class="w3-large"><b>Nicholas Ramirez Ornalez</b></p>
            <p>All my new playlists have been great since I started using SentiSounds. Shaboing!</p>
        </div>
    </div>
</div>
</body>

</html>
